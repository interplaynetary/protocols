import{_ as s,o as t,c as e,ag as n}from"./chunks/framework.BSbZkL3e.js";const u=JSON.parse('{"title":"Architecture","description":"","frontmatter":{},"headers":[],"relativePath":"happyview/architecture.md","filePath":"happyview/architecture.md"}'),i={name:"happyview/architecture.md"};function d(r,a,p,o,l,c){return t(),e("div",null,[...a[0]||(a[0]=[n(`<h1 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to &quot;Architecture&quot;">​</a></h1><p>Guide for contributors working on HappyView itself.</p><h2 id="module-overview" tabindex="-1">Module overview <a class="header-anchor" href="#module-overview" aria-label="Permalink to &quot;Module overview&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>src/</span></span>
<span class="line"><span>  main.rs           Startup: config, DB, migrations, spawn workers, start server</span></span>
<span class="line"><span>  lib.rs            AppState struct, module declarations</span></span>
<span class="line"><span>  config.rs         Environment variable loading</span></span>
<span class="line"><span>  error.rs          AppError enum (Auth, BadRequest, Forbidden, Internal, NotFound, PdsError)</span></span>
<span class="line"><span>  server.rs         Axum router: fixed routes + admin nest + XRPC catch-all</span></span>
<span class="line"><span>  lexicon.rs        ParsedLexicon, LexiconRegistry (Arc&lt;RwLock&lt;HashMap&gt;&gt;)</span></span>
<span class="line"><span>  profile.rs        DID document resolution, PDS discovery, profile fetching</span></span>
<span class="line"><span>  jetstream.rs      Jetstream WebSocket listener, record indexing</span></span>
<span class="line"><span>  backfill.rs       Background worker for bulk record ingestion</span></span>
<span class="line"><span>  auth/</span></span>
<span class="line"><span>    middleware.rs   Claims extractor (validates Bearer token via AIP /oauth/userinfo)</span></span>
<span class="line"><span>  admin/</span></span>
<span class="line"><span>    mod.rs          Admin route definitions</span></span>
<span class="line"><span>    auth.rs         AdminAuth extractor (Claims + DID lookup + auto-bootstrap)</span></span>
<span class="line"><span>    admins.rs       Admin CRUD handlers</span></span>
<span class="line"><span>    lexicons.rs     Lexicon CRUD handlers</span></span>
<span class="line"><span>    stats.rs        Record count stats</span></span>
<span class="line"><span>    backfill.rs     Backfill job creation and status</span></span>
<span class="line"><span>    types.rs        Request/response structs for admin endpoints</span></span>
<span class="line"><span>  repo/</span></span>
<span class="line"><span>    mod.rs          Re-exports</span></span>
<span class="line"><span>    dpop.rs         DPoP JWT proof generation (ES256/P-256)</span></span>
<span class="line"><span>    pds.rs          PDS proxy helpers (JSON POST, blob POST, response forwarding)</span></span>
<span class="line"><span>    session.rs      ATP session fetching from AIP</span></span>
<span class="line"><span>    upload_blob.rs  Blob upload handler</span></span>
<span class="line"><span>    media.rs        Media blob URL enrichment</span></span>
<span class="line"><span>    at_uri.rs       AT URI parsing</span></span>
<span class="line"><span>  xrpc/</span></span>
<span class="line"><span>    mod.rs          Re-exports</span></span>
<span class="line"><span>    query.rs        Dynamic GET handler (single record + list with pagination)</span></span>
<span class="line"><span>    procedure.rs    Dynamic POST handler (create vs put auto-detection)</span></span></code></pre></div><h2 id="request-flow" tabindex="-1">Request flow <a class="header-anchor" href="#request-flow" aria-label="Permalink to &quot;Request flow&quot;">​</a></h2><h3 id="reads-queries" tabindex="-1">Reads (queries) <a class="header-anchor" href="#reads-queries" aria-label="Permalink to &quot;Reads (queries)&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Client GET /xrpc/{method}?params</span></span>
<span class="line"><span>  -&gt; xrpc::xrpc_get()</span></span>
<span class="line"><span>  -&gt; LexiconRegistry lookup (must be Query type)</span></span>
<span class="line"><span>  -&gt; SQL query on records table (collection from target_collection)</span></span>
<span class="line"><span>  -&gt; Media blob URL enrichment</span></span>
<span class="line"><span>  -&gt; JSON response</span></span></code></pre></div><h3 id="writes-procedures" tabindex="-1">Writes (procedures) <a class="header-anchor" href="#writes-procedures" aria-label="Permalink to &quot;Writes (procedures)&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Client POST /xrpc/{method} + Bearer token</span></span>
<span class="line"><span>  -&gt; Claims extractor validates token via AIP /oauth/userinfo</span></span>
<span class="line"><span>  -&gt; xrpc::xrpc_post()</span></span>
<span class="line"><span>  -&gt; LexiconRegistry lookup (must be Procedure type)</span></span>
<span class="line"><span>  -&gt; Fetch ATP session from AIP /api/atprotocol/session</span></span>
<span class="line"><span>  -&gt; Generate DPoP proof (ES256)</span></span>
<span class="line"><span>  -&gt; Proxy to user&#39;s PDS (createRecord or putRecord)</span></span>
<span class="line"><span>  -&gt; Upsert record locally</span></span>
<span class="line"><span>  -&gt; Forward PDS response</span></span></code></pre></div><h3 id="admin-endpoints" tabindex="-1">Admin endpoints <a class="header-anchor" href="#admin-endpoints" aria-label="Permalink to &quot;Admin endpoints&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Client request + Bearer token</span></span>
<span class="line"><span>  -&gt; AdminAuth extractor:</span></span>
<span class="line"><span>     1. Claims validation via AIP</span></span>
<span class="line"><span>     2. DID lookup in admins table (auto-bootstrap if empty)</span></span>
<span class="line"><span>     3. 403 if not admin</span></span>
<span class="line"><span>  -&gt; Admin handler</span></span>
<span class="line"><span>  -&gt; JSON response</span></span></code></pre></div><h2 id="data-flow" tabindex="-1">Data flow <a class="header-anchor" href="#data-flow" aria-label="Permalink to &quot;Data flow&quot;">​</a></h2><h3 id="real-time-indexing" tabindex="-1">Real-time indexing <a class="header-anchor" href="#real-time-indexing" aria-label="Permalink to &quot;Real-time indexing&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Jetstream WebSocket</span></span>
<span class="line"><span>  -&gt; Filter by wantedCollections (from record-type lexicons)</span></span>
<span class="line"><span>  -&gt; commit events:</span></span>
<span class="line"><span>     create/update -&gt; UPSERT into records table</span></span>
<span class="line"><span>     delete        -&gt; DELETE from records table</span></span>
<span class="line"><span>  -&gt; Cursor tracked in AtomicI64 (rewinds 5s on reconnect)</span></span></code></pre></div><h3 id="backfill" tabindex="-1">Backfill <a class="header-anchor" href="#backfill" aria-label="Permalink to &quot;Backfill&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>backfill_jobs table (status = pending)</span></span>
<span class="line"><span>  -&gt; Worker picks up job</span></span>
<span class="line"><span>  -&gt; Relay listReposByCollection -&gt; list of DIDs</span></span>
<span class="line"><span>  -&gt; For each DID (8 concurrent):</span></span>
<span class="line"><span>     PLC directory -&gt; PDS endpoint</span></span>
<span class="line"><span>     PDS listRecords -&gt; UPSERT into records table</span></span>
<span class="line"><span>  -&gt; Update job status and counters</span></span></code></pre></div><h2 id="database-schema" tabindex="-1">Database schema <a class="header-anchor" href="#database-schema" aria-label="Permalink to &quot;Database schema&quot;">​</a></h2><h3 id="records" tabindex="-1"><code>records</code> <a class="header-anchor" href="#records" aria-label="Permalink to &quot;\`records\`&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Column</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>uri</code></td><td>text (PK)</td><td>AT URI (<code>at://did/collection/rkey</code>)</td></tr><tr><td><code>did</code></td><td>text</td><td>Author DID</td></tr><tr><td><code>collection</code></td><td>text</td><td>Lexicon NSID</td></tr><tr><td><code>rkey</code></td><td>text</td><td>Record key</td></tr><tr><td><code>record</code></td><td>jsonb</td><td>Record value</td></tr><tr><td><code>cid</code></td><td>text</td><td>Content identifier</td></tr><tr><td><code>indexed_at</code></td><td>timestamptz</td><td>When HappyView indexed this record</td></tr></tbody></table><h3 id="lexicons" tabindex="-1"><code>lexicons</code> <a class="header-anchor" href="#lexicons" aria-label="Permalink to &quot;\`lexicons\`&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Column</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>text (PK)</td><td>Lexicon NSID</td></tr><tr><td><code>revision</code></td><td>integer</td><td>Incremented on upsert</td></tr><tr><td><code>lexicon_json</code></td><td>jsonb</td><td>Raw lexicon definition</td></tr><tr><td><code>lexicon_type</code></td><td>text</td><td>record, query, procedure, definitions</td></tr><tr><td><code>backfill</code></td><td>boolean</td><td>Whether to backfill on upload</td></tr><tr><td><code>target_collection</code></td><td>text</td><td>For queries/procedures: which record collection</td></tr><tr><td><code>created_at</code></td><td>timestamptz</td><td></td></tr><tr><td><code>updated_at</code></td><td>timestamptz</td><td></td></tr></tbody></table><h3 id="admins" tabindex="-1"><code>admins</code> <a class="header-anchor" href="#admins" aria-label="Permalink to &quot;\`admins\`&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Column</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>uuid (PK)</td><td></td></tr><tr><td><code>did</code></td><td>text (unique)</td><td>Admin&#39;s ATProto DID</td></tr><tr><td><code>created_at</code></td><td>timestamptz</td><td></td></tr><tr><td><code>last_used_at</code></td><td>timestamptz</td><td>Updated on each authenticated request</td></tr></tbody></table><h3 id="backfill-jobs" tabindex="-1"><code>backfill_jobs</code> <a class="header-anchor" href="#backfill-jobs" aria-label="Permalink to &quot;\`backfill_jobs\`&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Column</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>id</code></td><td>uuid (PK)</td><td></td></tr><tr><td><code>collection</code></td><td>text</td><td>Target collection (null = all)</td></tr><tr><td><code>did</code></td><td>text</td><td>Target DID (null = all)</td></tr><tr><td><code>status</code></td><td>text</td><td>pending, running, completed, failed</td></tr><tr><td><code>total_repos</code></td><td>integer</td><td></td></tr><tr><td><code>processed_repos</code></td><td>integer</td><td></td></tr><tr><td><code>total_records</code></td><td>integer</td><td></td></tr><tr><td><code>error</code></td><td>text</td><td>Error message if failed</td></tr><tr><td><code>started_at</code></td><td>timestamptz</td><td></td></tr><tr><td><code>completed_at</code></td><td>timestamptz</td><td></td></tr><tr><td><code>created_at</code></td><td>timestamptz</td><td></td></tr></tbody></table><h2 id="testing" tabindex="-1">Testing <a class="header-anchor" href="#testing" aria-label="Permalink to &quot;Testing&quot;">​</a></h2><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Unit tests (no database needed)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cargo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --lib</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># All tests including e2e (requires Postgres)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compose</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-compose.test.yml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> up</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">TEST_DATABASE_URL</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">postgres://happyview:happyview@localhost:5433/happyview_test</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cargo</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> test</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">docker</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> compose</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -f</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> docker-compose.test.yml</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> down</span></span></code></pre></div><p>E2e tests use <code>wiremock</code> to mock external services (AIP, PLC directory, PDSes) and a real Postgres database for full integration coverage.</p>`,28)])])}const k=s(i,[["render",d]]);export{u as __pageData,k as default};
