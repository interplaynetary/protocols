import{_ as a,o as i,c as s,ag as t}from"./chunks/framework.BSbZkL3e.js";const k=JSON.parse('{"title":"Network Lexicons","description":"","frontmatter":{},"headers":[],"relativePath":"happyview/network-lexicons.md","filePath":"happyview/network-lexicons.md"}'),n={name:"happyview/network-lexicons.md"};function o(r,e,l,h,c,p){return i(),s("div",null,[...e[0]||(e[0]=[t(`<h1 id="network-lexicons" tabindex="-1">Network Lexicons <a class="header-anchor" href="#network-lexicons" aria-label="Permalink to &quot;Network Lexicons&quot;">​</a></h1><p>Network lexicons are lexicon definitions that HappyView fetches directly from the ATProto network rather than being uploaded manually via the admin API. An admin specifies an NSID, HappyView resolves the authority&#39;s repo, fetches the lexicon record, and keeps it updated via Jetstream.</p><h2 id="how-it-works" tabindex="-1">How it works <a class="header-anchor" href="#how-it-works" aria-label="Permalink to &quot;How it works&quot;">​</a></h2><h3 id="nsid-authority-resolution" tabindex="-1">NSID authority resolution <a class="header-anchor" href="#nsid-authority-resolution" aria-label="Permalink to &quot;NSID authority resolution&quot;">​</a></h3><p>Lexicon records live in repos as <code>com.atproto.lexicon.schema</code> with the rkey set to the NSID. To find which repo holds a lexicon, HappyView resolves the NSID&#39;s authority:</p><ol><li>Extract the authority from the NSID (all segments except the last). For example, <code>games.gamesgamesgamesgames.game</code> has authority <code>games.gamesgamesgamesgames</code>.</li><li>Reverse the authority segments to form a domain: <code>gamesgamesgamesgames.games</code>.</li><li>Look up the DNS TXT record at <code>_lexicon.{domain}</code> (e.g. <code>_lexicon.gamesgamesgamesgames.games</code>).</li><li>Parse the TXT record for a <code>did=&lt;DID&gt;</code> value.</li><li>Resolve the DID to a PDS endpoint via the PLC directory.</li></ol><p>Resolution is <strong>non-hierarchical</strong> --- each authority requires its own explicit TXT record.</p><h3 id="fetching" tabindex="-1">Fetching <a class="header-anchor" href="#fetching" aria-label="Permalink to &quot;Fetching&quot;">​</a></h3><p>Once the authority DID and PDS endpoint are known, HappyView calls <code>com.atproto.repo.getRecord</code> with:</p><ul><li><code>repo</code> = the authority DID</li><li><code>collection</code> = <code>com.atproto.lexicon.schema</code></li><li><code>rkey</code> = the NSID</li></ul><p>The <code>value</code> field of the response is the raw lexicon JSON.</p><h3 id="live-updates-via-jetstream" tabindex="-1">Live updates via Jetstream <a class="header-anchor" href="#live-updates-via-jetstream" aria-label="Permalink to &quot;Live updates via Jetstream&quot;">​</a></h3><p>Jetstream always subscribes to <code>com.atproto.lexicon.schema</code> alongside the dynamic record collections. When a commit event arrives:</p><ul><li><strong>create/update</strong>: If the event&#39;s DID and rkey match a tracked network lexicon (<code>authority_did</code> and <code>nsid</code>), the lexicon is parsed, upserted into the <code>lexicons</code> table and in-memory registry, and Jetstream is notified if it&#39;s a record type.</li><li><strong>delete</strong>: The lexicon is removed from the <code>lexicons</code> table and registry.</li></ul><h3 id="startup-re-fetch" tabindex="-1">Startup re-fetch <a class="header-anchor" href="#startup-re-fetch" aria-label="Permalink to &quot;Startup re-fetch&quot;">​</a></h3><p>On every startup, HappyView re-fetches all network lexicons from their respective PDSes. This ensures consistency even if Jetstream events were missed while offline. Failures are logged as warnings but don&#39;t block startup.</p><h2 id="admin-api" tabindex="-1">Admin API <a class="header-anchor" href="#admin-api" aria-label="Permalink to &quot;Admin API&quot;">​</a></h2><p>See <a href="./admin-api.html#network-lexicons">Admin API - Network Lexicons</a> for endpoint details.</p><h3 id="quick-reference" tabindex="-1">Quick reference <a class="header-anchor" href="#quick-reference" aria-label="Permalink to &quot;Quick reference&quot;">​</a></h3><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Add a network lexicon</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> POST</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:3000/admin/network-lexicons</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$AUTH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;Content-Type: application/json&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;{ &quot;nsid&quot;: &quot;games.gamesgamesgamesgames.game&quot; }&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># List tracked network lexicons</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:3000/admin/network-lexicons</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$AUTH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Remove a network lexicon</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">curl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -X</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> DELETE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> http://localhost:3000/admin/network-lexicons/games.gamesgamesgamesgames.game</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> \\</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  -H</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$AUTH</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span></code></pre></div>`,20)])])}const m=a(n,[["render",o]]);export{k as __pageData,m as default};
